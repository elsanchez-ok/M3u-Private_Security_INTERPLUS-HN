<script>
// Sistema de dashboard con NocoDB
document.addEventListener('DOMContentLoaded', async function() {
    // Verificar autenticación
    const isAuthenticated = await window.nocodbAuth.requireAuth('user');
    if (!isAuthenticated) return;
    
    // Cargar información del usuario
    const user = window.nocodbAuth.getCurrentUser();
    
    // Actualizar UI
    document.getElementById('sessionUser').textContent = user.username;
    document.getElementById('userType').textContent = user.user_type === 'admin' ? 'Administrador' : 'Usuario';
    
    // Iniciar monitoreo de sesión
    window.nocodbAuth.startSessionMonitoring();
    
    // Configurar eventos
    document.getElementById('logoutBtn').addEventListener('click', async function() {
        await window.nocodbAuth.logout();
        window.location.href = 'index.html';
    });
    
    // Cargar stream
    async function loadStream() {
        try {
            const streamData = await window.nocodbAuth.getStream();
            
            if (streamData.stream_url) {
                const videoPlayer = document.getElementById('liveStream');
                videoPlayer.src = streamData.stream_url;
                
                // Mostrar controles
                document.getElementById('videoOverlay').style.display = 'none';
                videoPlayer.style.display = 'block';
                
                showMessage('Stream cargado exitosamente', 'success');
            }
        } catch (error) {
            showMessage('Error al cargar stream: ' + error.message, 'error');
        }
    }
    
    // Función para mostrar mensajes
    function showMessage(text, type) {
        const messageEl = document.getElementById('message') || 
                         document.getElementById('sessionAlert');
        
        if (messageEl) {
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }
    }
    
    // Cargar stream después de 2 segundos
    setTimeout(loadStream, 2000);
    
    // Botón para recargar stream
    document.getElementById('refreshStreamBtn').addEventListener('click', loadStream);
});
</script>
